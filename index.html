<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>The Dark Creed Alliance</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: linear-gradient(
          135deg,
          #0a0a0a 0%,
          #1a1a1a 50%,
          #0a0a0a 100%
        );
        color: #e0e0e0;
        line-height: 1.6;
        min-height: 100vh;
        font-size: 16px;
        -webkit-text-size-adjust: 100%;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 10px;
      }
      @media (min-width: 768px) {
        .container {
          padding: 20px;
        }
      }
      .header {
        background: linear-gradient(
          135deg,
          #1a0d2e 0%,
          #2d1b69 50%,
          #0f0f23 100%
        );
        padding: 40px;
        border-radius: 20px;
        margin-bottom: 30px;
        box-shadow: 0 8px 32px rgba(45, 27, 105, 0.3),
          0 0 0 1px rgba(255, 255, 255, 0.1);
        text-align: center;
        border: 1px solid rgba(74, 158, 255, 0.2);
        position: relative;
        overflow: hidden;
      }
      .header::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: radial-gradient(
          circle at 50% 50%,
          rgba(74, 158, 255, 0.1) 0%,
          transparent 70%
        );
        pointer-events: none;
      }
      h1 {
        color: #4a9eff;
        font-size: 2em;
        margin-bottom: 10px;
        font-weight: 700;
        text-shadow: 0 0 20px rgba(74, 158, 255, 0.5);
        position: relative;
        z-index: 1;
      }
      @media (min-width: 768px) {
        h1 {
          font-size: 3em;
        }
      }
      .subtitle {
        color: #b8b8b8;
        font-size: 1.2em;
        font-weight: 300;
        position: relative;
        z-index: 1;
      }
      .auth-section {
        background: linear-gradient(135deg, #1a1a2e 0%, #161625 100%);
        padding: 25px;
        border-radius: 15px;
        margin-bottom: 30px;
        border: 1px solid rgba(74, 158, 255, 0.2);
        transition: all 0.3s ease;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(10px);
      }
      .auth-section.hidden {
        display: none;
      }
      .auth-section input {
        background: rgba(10, 10, 10, 0.8);
        border: 1px solid rgba(74, 158, 255, 0.3);
        color: #e0e0e0;
        padding: 12px 16px;
        border-radius: 10px;
        width: 300px;
        max-width: 100%;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
      }
      .auth-section input:focus {
        outline: none;
        border-color: #4a9eff;
        box-shadow: 0 0 0 3px rgba(74, 158, 255, 0.1);
      }
      .btn {
        background: linear-gradient(135deg, #4a9eff 0%, #357abd 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 10px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        transition: all 0.3s ease;
        margin: 5px;
        width: 100%;
        touch-action: manipulation;
        box-shadow: 0 4px 12px rgba(74, 158, 255, 0.3);
        position: relative;
        overflow: hidden;
      }
      .btn::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
        transition: left 0.5s;
      }
      .btn:hover::before {
        left: 100%;
      }
      @media (min-width: 768px) {
        .btn {
          width: auto;
          padding: 12px 24px;
        }
      }
      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(74, 158, 255, 0.4);
      }
      .btn-danger {
        background: linear-gradient(135deg, #ff4444 0%, #cc3333 100%);
        box-shadow: 0 4px 12px rgba(255, 68, 68, 0.3);
      }
      .btn-danger:hover {
        box-shadow: 0 6px 20px rgba(255, 68, 68, 0.4);
      }
      .btn-success {
        background: linear-gradient(135deg, #44ff44 0%, #33cc33 100%);
        color: #0a0a0a;
        box-shadow: 0 4px 12px rgba(68, 255, 68, 0.3);
      }
      .btn-success:hover {
        box-shadow: 0 6px 20px rgba(68, 255, 68, 0.4);
      }
      .member-form {
        background: linear-gradient(135deg, #1a1a2e 0%, #161625 100%);
        padding: 35px;
        border-radius: 20px;
        margin-bottom: 30px;
        border: 1px solid rgba(74, 158, 255, 0.2);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(10px);
      }
      .form-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 15px;
        margin-bottom: 20px;
      }
      @media (min-width: 768px) {
        .form-grid {
          grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
          gap: 20px;
        }
      }
      .form-group label {
        display: block;
        margin-bottom: 5px;
        color: #4a9eff;
        font-weight: 500;
      }
      .form-group input,
      .form-group select {
        width: 100%;
        padding: 12px 16px;
        background: rgba(10, 10, 10, 0.8);
        border: 1px solid rgba(74, 158, 255, 0.3);
        border-radius: 10px;
        color: #e0e0e0;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
      }
      .form-group input:focus,
      .form-group select:focus {
        outline: none;
        border-color: #4a9eff;
        box-shadow: 0 0 0 3px rgba(74, 158, 255, 0.1);
      }
      .members-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 20px;
        margin-bottom: 30px;
      }
      @media (min-width: 768px) {
        .members-grid {
          grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
          gap: 25px;
        }
      }
      .member-card {
        background: linear-gradient(135deg, #1a1a2e 0%, #161625 100%);
        padding: 25px;
        border-radius: 15px;
        border: 1px solid rgba(74, 158, 255, 0.2);
        transition: all 0.4s ease;
        position: relative;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(10px);
        overflow: hidden;
      }
      .member-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: radial-gradient(
          circle at 50% 0%,
          rgba(74, 158, 255, 0.05) 0%,
          transparent 70%
        );
        opacity: 0;
        transition: opacity 0.3s ease;
      }
      .member-card:hover::before {
        opacity: 1;
      }
      .member-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 12px 40px rgba(74, 158, 255, 0.2);
        border-color: rgba(74, 158, 255, 0.4);
      }
      .member-card h3 {
        color: #4a9eff;
        margin-bottom: 15px;
        font-size: 1.3em;
        font-weight: 600;
        position: relative;
        z-index: 1;
      }
      .member-card .stats {
        font-size: 14px;
        color: #b8b8b8;
        margin-bottom: 12px;
        position: relative;
        z-index: 1;
      }
      .member-card .power {
        color: #ff9944;
        font-weight: bold;
      }
      .member-card .tower {
        color: #44ff99;
      }
      .time-slots {
        background: rgba(10, 10, 10, 0.6);
        padding: 15px;
        border-radius: 10px;
        margin-top: 15px;
        font-size: 12px;
        border: 1px solid rgba(74, 158, 255, 0.1);
        position: relative;
        z-index: 1;
      }
      .pending-section {
        background: linear-gradient(135deg, #2e2e1a 0%, #252513 100%);
        padding: 25px;
        border-radius: 15px;
        margin-bottom: 30px;
        border: 1px solid rgba(255, 204, 0, 0.2);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
      }
      .pending-item {
        background: rgba(10, 10, 10, 0.6);
        padding: 20px;
        margin-bottom: 15px;
        border-radius: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 1px solid rgba(255, 204, 0, 0.1);
        transition: all 0.3s ease;
      }
      .pending-item:hover {
        background: rgba(10, 10, 10, 0.8);
        border-color: rgba(255, 204, 0, 0.3);
      }
      .timeline {
        background: linear-gradient(135deg, #1a1a2e 0%, #161625 100%);
        padding: 25px;
        border-radius: 20px;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        border: 1px solid rgba(74, 158, 255, 0.2);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      }
      @media (min-width: 768px) {
        .timeline {
          padding: 20px;
        }
      }
      .timeline-header {
        display: grid;
        grid-template-columns: 100px repeat(24, 40px);
        font-size: 12px;
        margin-bottom: 10px;
        color: #666;
      }
      .timeline-row {
        display: grid;
        grid-template-columns: 100px repeat(24, 40px);
        margin-bottom: 5px;
        align-items: center;
      }
      .timeline-cell {
        height: 30px;
        border: 1px solid #333;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
      }
      .available {
        background: #44ff44;
        color: #0a0a0a;
      }
      .message {
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
        text-align: center;
      }
      .success {
        background: #1a3a1a;
        color: #44ff44;
      }
      .error {
        background: #3a1a1a;
        color: #ff4444;
      }
      .time-slot-grid {
        display: grid;
        grid-template-columns: 60px repeat(2, 1fr);
        gap: 5px;
        margin-bottom: 10px;
        align-items: stretch;
      }
      @media (min-width: 768px) {
        .time-slot-grid {
          grid-template-columns: 100px repeat(6, 1fr);
          gap: 10px;
          margin-bottom: 15px;
        }
      }
      .time-slot-header {
        font-weight: bold;
        color: #4a9eff;
        text-align: center;
        padding: 5px;
        background: #0a0a0a;
        border-radius: 5px;
        font-size: 11px;
      }
      @media (min-width: 768px) {
        .time-slot-header {
          padding: 10px;
          font-size: 14px;
        }
      }
      .time-slot-day {
        font-weight: 500;
        color: #888;
        padding: 5px;
        font-size: 12px;
      }
      .time-slot-btn {
        padding: 10px 6px;
        background: rgba(10, 10, 10, 0.8);
        border: 2px solid rgba(74, 158, 255, 0.3);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
        font-size: 11px;
        min-height: 45px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 500;
        backdrop-filter: blur(10px);
      }
      @media (min-width: 768px) {
        .time-slot-btn {
          padding: 12px;
          font-size: 14px;
        }
      }
      .time-slot-btn:hover {
        border-color: #4a9eff;
        background: rgba(74, 158, 255, 0.1);
        transform: scale(1.05);
      }
      .time-slot-btn.active {
        background: linear-gradient(135deg, #4a9eff 0%, #357abd 100%);
        border-color: #4a9eff;
        color: white;
        box-shadow: 0 4px 12px rgba(74, 158, 255, 0.3);
      }
      #loadingIndicator {
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #4a9eff 0%, #357abd 100%);
        color: white;
        padding: 12px 24px;
        border-radius: 10px;
        display: none;
        box-shadow: 0 4px 16px rgba(74, 158, 255, 0.3);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(74, 158, 255, 0.2);
      }
    </style>
  </head>
  <body>
    <div id="loadingIndicator">Loading...</div>
    <div class="container">
      <div class="header">
        <h1>The Dark Creed Alliance</h1>
        <p class="subtitle">Unite. Strategize. Dominate.</p>
      </div>

      <div id="messageArea"></div>

      <div id="authSection" class="auth-section">
        <h2>Authentication</h2>
        <p style="margin-bottom: 15px">
          <span id="authStatus">Not authenticated</span>
        </p>
        <div id="authControls">
          <input
            type="password"
            id="githubToken"
            placeholder="GitHub Token (for R4s only)"
          />
          <button class="btn" onclick="authenticateR4()">
            Authenticate as R4
          </button>
        </div>
        <button
          class="btn btn-danger"
          onclick="logout()"
          id="logoutBtn"
          style="display: none"
        >
          Logout
        </button>
      </div>

      <div class="member-form">
        <h2>Submit Your Information</h2>
        <div class="form-grid">
          <div class="form-group">
            <label>In-Game Username</label>
            <input type="text" id="username" placeholder="Your username" />
          </div>
          <div class="form-group">
            <label>Main Car Power</label>
            <input type="number" id="carPower" placeholder="e.g., 150000" />
          </div>
          <div class="form-group">
            <label>Tower Level</label>
            <input
              type="number"
              id="towerLevel"
              min="1"
              max="33"
              placeholder="1-33"
            />
          </div>
          <div class="form-group">
            <label>Timezone</label>
            <select id="timezone"></select>
            <small
              id="serverTimeInfo"
              style="color: #888; display: block; margin-top: 5px"
            ></small>
          </div>
        </div>
        <h3 style="margin: 20px 0 10px">Available Time Slots</h3>
        <p style="color: #888; margin-bottom: 15px; font-size: 14px">
          Select when you're usually available (2-hour blocks in your local
          time)
        </p>
        <div id="timeSlotHeaders"></div>
        <div id="timeSlotInputs"></div>
        <button class="btn btn-success" onclick="submitMemberInfo()">
          Submit Information
        </button>
      </div>

      <div id="pendingSection" class="pending-section hidden">
        <h2>Pending Submissions</h2>
        <div id="pendingList"></div>
      </div>

             <div class="timeline">
         <h2>Alliance Timeline (UTC)</h2>
         <div id="timelineView"></div>
       </div>

       <div class="members-grid" id="membersGrid"></div>
    </div>

    <script>
      const REPO_OWNER = "wissamyah";
      const REPO_NAME = "dws-alliance-scheduler";
      const DATA_FILE = "data.json";

      let authToken = localStorage.getItem("githubToken");
      let isR4 = false;
      let currentData = null;

      // Time slot definitions - 2 hour blocks
      const TIME_SLOTS = [
        { id: "slot1", name: "12AM-2AM", hours: [0, 1] },
        { id: "slot2", name: "2AM-4AM", hours: [2, 3] },
        { id: "slot3", name: "4AM-6AM", hours: [4, 5] },
        { id: "slot4", name: "6AM-8AM", hours: [6, 7] },
        { id: "slot5", name: "8AM-10AM", hours: [8, 9] },
        { id: "slot6", name: "10AM-12PM", hours: [10, 11] },
        { id: "slot7", name: "12PM-2PM", hours: [12, 13] },
        { id: "slot8", name: "2PM-4PM", hours: [14, 15] },
        { id: "slot9", name: "4PM-6PM", hours: [16, 17] },
        { id: "slot10", name: "6PM-8PM", hours: [18, 19] },
        { id: "slot11", name: "8PM-10PM", hours: [20, 21] },
        { id: "slot12", name: "10PM-12AM", hours: [22, 23] },
      ];

      // For mobile view, show 3 slots at a time
      const MOBILE_SLOT_GROUPS = [
        { label: "Night", slots: ["slot1", "slot2", "slot3"] },
        { label: "Morning", slots: ["slot4", "slot5", "slot6"] },
        { label: "Afternoon", slots: ["slot7", "slot8", "slot9"] },
        { label: "Evening", slots: ["slot10", "slot11", "slot12"] },
      ];

      function updateServerTimeDisplay() {
        const selectedTz = document.getElementById("timezone").value;
        if (!selectedTz) return;

        const tzOffset = parseInt(selectedTz.replace("UTC", "")) || 0;
        const serverOffset = -2; // Server is UTC-2
        const serverTime = new Date();
        serverTime.setHours(serverTime.getUTCHours() + serverOffset);

        const localTime = new Date();
        localTime.setHours(localTime.getUTCHours() + tzOffset);

        const timeDiff = tzOffset - serverOffset;
        const ahead = timeDiff > 0 ? "ahead of" : "behind";
        const diff = Math.abs(timeDiff);

        document.getElementById(
          "serverTimeInfo"
        ).innerHTML = `Server time is ${diff} hour${
          diff !== 1 ? "s" : ""
        } ${ahead} your selected timezone<br>
                 Current server time: ${serverTime
                   .toTimeString()
                   .slice(0, 5)} (UTC-2)`;
      }

      async function loadData() {
        showLoading(true);
        try {
          const response = await fetch(
            `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${DATA_FILE}`
          );
          const file = await response.json();
          const content = atob(file.content);
          currentData = JSON.parse(content);
          currentData.sha = file.sha;
          renderUI();
        } catch (error) {
          showMessage("Error loading data: " + error.message, "error");
        }
        showLoading(false);
      }

      async function saveData() {
        if (!isR4 || !authToken) {
          showMessage("Only R4s can save data", "error");
          return;
        }
        showLoading(true);
        try {
          currentData.lastUpdated = new Date().toISOString();
          const content = btoa(JSON.stringify(currentData, null, 2));

          const response = await fetch(
            `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${DATA_FILE}`,
            {
              method: "PUT",
              headers: {
                Authorization: `token ${authToken}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                message: "Update alliance data",
                content: content,
                sha: currentData.sha,
              }),
            }
          );

          if (!response.ok) throw new Error("Failed to save");

          const result = await response.json();
          currentData.sha = result.content.sha;
          showMessage("Data saved successfully!", "success");
        } catch (error) {
          showMessage("Error saving data: " + error.message, "error");
        }
        showLoading(false);
      }

      function authenticateR4() {
        const token = document.getElementById("githubToken").value;
        if (!token) {
          showMessage("Please enter a GitHub token", "error");
          return;
        }
        authToken = token;
        localStorage.setItem("githubToken", token);
        isR4 = true;
        updateAuthStatus();
        renderUI();
        showMessage("Authenticated as R4!", "success");

        // Hide auth section for R4s
        document.getElementById("authSection").classList.add("hidden");
      }

      function logout() {
        authToken = null;
        isR4 = false;
        localStorage.removeItem("githubToken");
        document.getElementById("githubToken").value = "";
        updateAuthStatus();
        renderUI();

        // Show auth section again
        document.getElementById("authSection").classList.remove("hidden");
      }

      function updateAuthStatus() {
        const isAuthenticated = isR4;
        document.getElementById("authStatus").textContent = isAuthenticated
          ? "Authenticated as R4"
          : "Not authenticated";
        document
          .getElementById("pendingSection")
          .classList.toggle("hidden", !isAuthenticated);
        document.getElementById("authControls").style.display = isAuthenticated
          ? "none"
          : "block";
        document.getElementById("logoutBtn").style.display = isAuthenticated
          ? "inline-block"
          : "none";
      }

      function submitMemberInfo() {
        const username = document.getElementById("username").value;
        const carPower = document.getElementById("carPower").value;
        const towerLevel = document.getElementById("towerLevel").value;
        const timezone = document.getElementById("timezone").value;

        if (!username || !carPower || !towerLevel) {
          showMessage("Please fill all required fields", "error");
          return;
        }

        const timeSlots = {};
        const days = [
          "monday",
          "tuesday",
          "wednesday",
          "thursday",
          "friday",
          "saturday",
          "sunday",
        ];

        days.forEach((day) => {
          const daySlots = [];
          TIME_SLOTS.forEach((slot) => {
            const btn = document.querySelector(
              `[data-day="${day}"][data-slot="${slot.id}"]`
            );
            if (btn && btn.classList.contains("active")) {
              daySlots.push(slot.id);
            }
          });
          if (daySlots.length > 0) {
            timeSlots[day] = daySlots;
          }
        });

        const submission = {
          id: Date.now(),
          username,
          carPower: parseInt(carPower),
          towerLevel: parseInt(towerLevel),
          timezone,
          availability: timeSlots,
          submittedAt: new Date().toISOString(),
        };

        if (isR4) {
          currentData.members.push(submission);
          saveData();
          showMessage("Member added successfully!", "success");
        } else {
          currentData.pendingSubmissions.push(submission);
          saveData();
          showMessage(
            "Your information has been submitted for review!",
            "success"
          );
        }

        // Clear form
        document.getElementById("username").value = "";
        document.getElementById("carPower").value = "";
        document.getElementById("towerLevel").value = "";
        document.querySelectorAll(".time-slot-btn.active").forEach((btn) => {
          btn.classList.remove("active");
        });
      }

      function toggleTimeSlot(day, slotId) {
        const btn = document.querySelector(
          `[data-day="${day}"][data-slot="${slotId}"]`
        );
        btn.classList.toggle("active");
      }

      function approvePending(id) {
        const pending = currentData.pendingSubmissions.find((p) => p.id === id);
        if (pending) {
          currentData.members.push(pending);
          currentData.pendingSubmissions =
            currentData.pendingSubmissions.filter((p) => p.id !== id);
          saveData();
        }
      }

      function rejectPending(id) {
        currentData.pendingSubmissions = currentData.pendingSubmissions.filter(
          (p) => p.id !== id
        );
        saveData();
      }

      function deleteMember(id) {
        if (!isR4) return;
        currentData.members = currentData.members.filter((m) => m.id !== id);
        saveData();
      }

      function renderUI() {
        if (!currentData) return;

        // Populate timezone dropdown
        const timezoneSelect = document.getElementById("timezone");
        timezoneSelect.innerHTML = currentData.config.timezones
          .map((tz) => `<option value="${tz}">${tz}</option>`)
          .join("");
        timezoneSelect.addEventListener("change", updateServerTimeDisplay);
        updateServerTimeDisplay();

        // Render time slot inputs
        const days = [
          "Monday",
          "Tuesday",
          "Wednesday",
          "Thursday",
          "Friday",
          "Saturday",
          "Sunday",
        ];
        const isMobile = window.innerWidth < 768;

        // Headers
        if (isMobile) {
          // Mobile: Show time slots in groups
          document.getElementById("timeSlotHeaders").innerHTML = `
                    <div style="margin-bottom: 20px;">
                        ${MOBILE_SLOT_GROUPS.map(
                          (group) => `
                            <div style="margin-bottom: 15px;">
                                <h4 style="color: #4a9eff; margin-bottom: 10px;">${
                                  group.label
                                }</h4>
                                <div class="time-slot-grid">
                                    <div></div>
                                    ${group.slots
                                      .map((slotId) => {
                                        const slot = TIME_SLOTS.find(
                                          (s) => s.id === slotId
                                        );
                                        return `<div class="time-slot-header">${slot.name}</div>`;
                                      })
                                      .join("")}
                                </div>
                                ${days
                                  .map(
                                    (day) => `
                                    <div class="time-slot-grid">
                                        <div class="time-slot-day">${day.slice(
                                          0,
                                          3
                                        )}</div>
                                        ${group.slots
                                          .map(
                                            (slotId) => `
                                            <div class="time-slot-btn" 
                                                 data-day="${day.toLowerCase()}" 
                                                 data-slot="${slotId}"
                                                 onclick="toggleTimeSlot('${day.toLowerCase()}', '${slotId}')">
                                                ✓
                                            </div>
                                        `
                                          )
                                          .join("")}
                                    </div>
                                `
                                  )
                                  .join("")}
                            </div>
                        `
                        ).join("")}
                    </div>
                `;
          document.getElementById("timeSlotInputs").innerHTML = "";
        } else {
          // Desktop: Show all slots in one grid
          document.getElementById("timeSlotHeaders").innerHTML = `
                    <div class="time-slot-grid">
                        <div></div>
                        ${TIME_SLOTS.slice(0, 6)
                          .map(
                            (slot) =>
                              `<div class="time-slot-header">${slot.name}</div>`
                          )
                          .join("")}
                    </div>
                    <div class="time-slot-grid">
                        <div></div>
                        ${TIME_SLOTS.slice(6)
                          .map(
                            (slot) =>
                              `<div class="time-slot-header">${slot.name}</div>`
                          )
                          .join("")}
                    </div>
                `;

          document.getElementById("timeSlotInputs").innerHTML = days
            .map(
              (day) => `
                    <div>
                        <div class="time-slot-grid">
                            <div class="time-slot-day">${day}</div>
                            ${TIME_SLOTS.slice(0, 6)
                              .map(
                                (slot) => `
                                <div class="time-slot-btn" 
                                     data-day="${day.toLowerCase()}" 
                                     data-slot="${slot.id}"
                                     onclick="toggleTimeSlot('${day.toLowerCase()}', '${
                                  slot.id
                                }')">
                                    Available
                                </div>
                            `
                              )
                              .join("")}
                        </div>
                        <div class="time-slot-grid">
                            <div></div>
                            ${TIME_SLOTS.slice(6)
                              .map(
                                (slot) => `
                                <div class="time-slot-btn" 
                                     data-day="${day.toLowerCase()}" 
                                     data-slot="${slot.id}"
                                     onclick="toggleTimeSlot('${day.toLowerCase()}', '${
                                  slot.id
                                }')">
                                    Available
                                </div>
                            `
                              )
                              .join("")}
                        </div>
                    </div>
                `
            )
            .join("");
        }

        // Render members
        renderMembers();

        // Render pending (for R4s)
        if (isR4) {
          renderPending();
        }

        // Render timeline
        renderTimeline();
      }

      function renderMembers() {
        const grid = document.getElementById("membersGrid");
        grid.innerHTML = currentData.members
          .map(
            (member) => `
                <div class="member-card">
                    <h3>${member.username}</h3>
                    <div class="stats">
                        <span class="power">Power: ${member.carPower.toLocaleString()}</span> | 
                        <span class="tower">Tower: ${member.towerLevel}</span>
                    </div>
                    <div class="stats">Timezone: ${member.timezone}</div>
                    <div class="time-slots">
                        ${Object.entries(member.availability || {})
                          .map(([day, slots]) => {
                            const slotNames = slots.map((slotId) => {
                              const slot = TIME_SLOTS.find(
                                (s) => s.id === slotId
                              );
                              return slot ? slot.name : slotId;
                            });
                            return `<div><strong>${day}:</strong> ${slotNames.join(
                              ", "
                            )}</div>`;
                          })
                          .join("")}
                    </div>
                    ${
                      isR4
                        ? `<button class="btn btn-danger" onclick="deleteMember(${member.id})">Delete</button>`
                        : ""
                    }
                </div>
            `
          )
          .join("");
      }

      function renderPending() {
        const list = document.getElementById("pendingList");
        list.innerHTML = currentData.pendingSubmissions
          .map(
            (sub) => `
                <div class="pending-item">
                    <div>
                        <strong>${
                          sub.username
                        }</strong> - Power: ${sub.carPower.toLocaleString()}, Tower: ${
              sub.towerLevel
            }
                    </div>
                    <div>
                        <button class="btn btn-success" onclick="approvePending(${
                          sub.id
                        })">Approve</button>
                        <button class="btn btn-danger" onclick="rejectPending(${
                          sub.id
                        })">Reject</button>
                    </div>
                </div>
            `
          )
          .join("");
      }

      function renderTimeline() {
        const view = document.getElementById("timelineView");
        const days = [
          "monday",
          "tuesday",
          "wednesday",
          "thursday",
          "friday",
          "saturday",
          "sunday",
        ];
        const isMobile = window.innerWidth < 768;

        // Count members available in each slot
        const availability = {};
        days.forEach((day) => {
          availability[day] = {};
          TIME_SLOTS.forEach((slot) => {
            availability[day][slot.id] = currentData.members.filter(
              (m) =>
                m.availability[day] && m.availability[day].includes(slot.id)
            ).length;
          });
        });

        if (isMobile) {
          // Mobile view - simplified
          view.innerHTML = `
                    <div style="margin-top: 20px;">
                        <p style="text-align: center; color: #888; margin-bottom: 20px;">Member availability by time slot</p>
                        ${days
                          .map((day) => {
                            const maxCount = Math.max(
                              ...Object.values(availability[day])
                            );
                            const bestSlots = TIME_SLOTS.filter(
                              (slot) =>
                                availability[day][slot.id] === maxCount &&
                                maxCount > 0
                            );
                            return `
                                <div style="background: #161625; padding: 15px; margin-bottom: 10px; border-radius: 5px;">
                                    <h4 style="color: #4a9eff; text-transform: capitalize; margin-bottom: 10px;">${day}</h4>
                                    ${
                                      bestSlots.length > 0
                                        ? `
                                        <p style="color: #44ff44;">Best time: ${bestSlots
                                          .map((s) => s.name)
                                          .join(", ")}</p>
                                        <p style="color: #888; font-size: 14px;">${maxCount} members available</p>
                                    `
                                        : `
                                        <p style="color: #888;">No members available</p>
                                    `
                                    }
                                </div>
                            `;
                          })
                          .join("")}
                    </div>
                `;
        } else {
          // Desktop view - full grid
          view.innerHTML = `
                    <div style="margin-top: 20px; overflow-x: auto;">
                        <p style="text-align: center; color: #888; margin-bottom: 20px;">Darker green = more members available</p>
                        <table style="width: 100%; border-collapse: collapse;">
                            <tr>
                                <th style="padding: 10px; text-align: left;">Day</th>
                                ${TIME_SLOTS.map(
                                  (slot) =>
                                    `<th style="padding: 5px; text-align: center; font-size: 12px; color: #4a9eff;">${slot.name}</th>`
                                ).join("")}
                            </tr>
                            ${days
                              .map(
                                (day) => `
                                <tr>
                                    <td style="padding: 10px; text-transform: capitalize; font-weight: 500; color: #888;">${day}</td>
                                    ${TIME_SLOTS.map((slot) => {
                                      const count = availability[day][slot.id];
                                      const intensity = Math.min(
                                        count * 20,
                                        100
                                      );
                                      return `
                                            <td style="
                                                background: ${
                                                  count > 0
                                                    ? `rgba(68, 255, 68, ${
                                                        intensity / 100
                                                      })`
                                                    : "#0a0a0a"
                                                };
                                                color: ${
                                                  count > 0 ? "#000" : "#666"
                                                };
                                                padding: 10px;
                                                text-align: center;
                                                border: 1px solid #333;
                                                font-size: 12px;
                                            ">
                                                ${count}
                                            </td>
                                        `;
                                    }).join("")}
                                </tr>
                            `
                              )
                              .join("")}
                        </table>
                    </div>
                `;
        }
      }

      function showMessage(text, type) {
        const area = document.getElementById("messageArea");
        area.innerHTML = `<div class="message ${type}">${text}</div>`;
        setTimeout(() => (area.innerHTML = ""), 5000);
      }

      function showLoading(show) {
        document.getElementById("loadingIndicator").style.display = show
          ? "block"
          : "none";
      }

      // Initialize
      if (authToken) {
        isR4 = true;
        updateAuthStatus();
        // Hide auth section if already authenticated
        document.getElementById("authSection").classList.add("hidden");
      }
      loadData();

      // Auto-refresh every 30 seconds
      setInterval(loadData, 30000);

      // Re-render on window resize for responsive layout
      let resizeTimeout;
      window.addEventListener("resize", () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
          if (currentData) renderUI();
        }, 250);
      });
    </script>
  </body>
</html>
